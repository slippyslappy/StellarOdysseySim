<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Odyssey Player Setup</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #181c24; color: #e6eaf3; }
        .form-section { max-width: 1100px; margin-left: 0; margin-right: auto; display: flex; flex-direction: row; gap: 2em; }
        
        /* Tab styles */
        .tab-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #23283a;
            border-top: 1px solid #2c3242;
            display: flex;
            padding: 0.3em 2em;
            z-index: 1000;
        }
        .tab {
            padding: 0.8em 1.5em;
            background: #36405a;
            border: 1px solid #2c3242;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 0.2em;
            cursor: pointer;
            color: #e6eaf3;
            transition: background 0.2s;
        }
        .tab:hover {
            background: #4a5a7c;
        }
        .tab.active {
            background: #23283a;
            border-bottom: 1px solid #23283a;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            margin-bottom: 3em; /* Space for tabs */
        }
        .tab-content.active {
            display: block;
        }
        /* End tab styles */
        
        .form-section > div:first-child { flex: none; width: 420px; min-width: 420px; }
        .form-row { display: flex; gap: 1em; margin-bottom: 1em; }
        .form-group { flex: 1; display: flex; flex-direction: column; min-width: 180px; color: #e6eaf3; font-size: 1.08em; }
        .input-group { display: flex; align-items: center; }
        .input-group button {
            width: 2.2em;
            height: 1.6em;
            font-size: 1.1em;
            margin: 0 0.2em;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background 0.2s;
            box-sizing: border-box;
        }
        .input-group button:active {
            background: #2a3142;
        }
        .input-group input[type=number] {
            width: 3.84em;
            height: 1.32em;
            font-size: 1.14em;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #2c3242;
            background: #36405a;
            color: #e6eaf3;
            box-sizing: border-box;
        }
        .clone-modifiers-section {
            flex: none;
            display: grid;
            grid-template-rows: repeat(5, 110px); /* 5 rows for up to 10 clones */
            grid-template-columns: repeat(2, 230px);
            grid-auto-flow: row;
            gap: 0.5em;
            margin-left: 40px;
        }
        .clone-modifiers-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.25em 0.5em 0.15em 0.5em;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 260px;
            min-width: 260px;
            max-width: 260px;
            height: 110px;
            min-height: 110px;
            max-height: 110px;
            box-sizing: border-box;
            font-size: 0.98em;
            color: #e6eaf3;
        }
        .clone-modifiers-block:nth-child(2n) {
            margin-left: 2em;
        }
        .clone-label {
            font-weight: 600;
            margin-bottom: 0.25em;
            text-align: center;
            font-size: 1.04em;
            color: #e6eaf3;
        }
        .clone-field-group {
            display: flex;
            align-items: center;
            gap: 0.15em;
            margin-bottom: 0.15em;
            color: #e6eaf3;
        }
        .clone-field-group label {
            margin-bottom: 0;
            font-size: 0.97em;
            min-width: 90px;
            white-space: nowrap;
            color: #e6eaf3;
        }
        .clone-field-group input[type=number] {
            width: 3.2em;
            height: 1.1em;
            font-size: 0.98em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
            padding-left: 5px;
        }
        .clone-field-group .minus-btn,
        .clone-field-group .plus-btn {
            width: 1.44em;
            height: 1.08em;
            font-size: 0.92em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        label { margin-bottom: 0.2em; }
        button[type=button], button[type=submit] {
            margin-top: 1em; padding: 0.5em 1em;
            background: #36405a;
            color: #f3f6fa;
            border: 1px solid #4a5a7c;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: background 0.2s, color 0.2s;
        }
        button[type=button]:hover, button[type=submit]:hover {
            background: #4a5a7c;
            color: #fff;
        }
        .block-label { font-size: 1.22em; font-weight: 700; margin-bottom: 0.5em; color: #f3f6fa; letter-spacing: 0.01em; }
        #playerResult { margin-top: 1.5em; font-size: 1.1em; color: #f3f6fa; }
        @media (max-width: 900px) {
            .form-section { max-width: 100%; }
            .form-row { flex-direction: column; }
            .clone-modifiers-section { margin-left: 0; }
        }
        .input-group .minus-btn,
        .input-group .plus-btn {
            width: 1.73em;
            height: 1.30em;
            font-size: 1.02em;
            margin: 0 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_dmg,
        #shield_def {
            width: 5.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .player-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
        }
        .mob-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            margin-bottom: 1em;
            margin-left: 0em;
            align-self: flex-start;
        }
        #mob_name {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #weapon_ele1,
        #weapon_ele2 {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        #shield_ele1,
        #shield_ele2 {
            font-size: 1.0em;
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .battle-block {
            background: #23283a;
            border-radius: 6px;
            border: 1px solid #2c3242;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            margin-bottom: -0.5em;
            margin-top: 5.0em;
            min-height: 230px;
            color: #e6eaf3;
        }
        .optimizer-block {
            background: #23283a !important;
            border-radius: 6px;
            border: 1px solid #2c3242 !important;
            padding: 0.7em 1.2em 0.5em 1.2em;
            box-sizing: border-box;
            width: 370px;
            min-width: 370px;
            max-width: 370px;
            min-height: 230px;
            color: #e6eaf3;
        }
        footer {
            position: fixed;
            bottom: 3.2em;
            left: 2em;
            font-size: 1em;
            color: #928e8e;
            text-align: left;
            z-index: 999;
            background: #181c24;
            padding: 0.5em 0;
        }
        #n_fights {
            background: #36405a;
            color: #e6eaf3;
            border: 1px solid #2c3242;
        }
        .player-unallocated-label {
            font-size: 0.95em;
            color: #e6eaf3;
            font-weight: 400;
            margin-left: 6em;
            margin-right: 0.5em;
            margin-top: 0.2em;
            margin-bottom: 0.2em;
            /* Match .form-group label */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module">
        import { Player } from './player.js';
        import { Mob } from './mob.js';
        import { Battle } from './battle.js';
        import { CloneModifiers, MobName } from './dataclasses.js';
        import { millify } from './utils.js';
        import { Optimizer } from './optimizer.js';
        import { WorkerPool } from './workerpool.js';
        
        // Predefined test values for easy testing
        const DEFAULTS = {
            power: 0,
            precision: 0,
            evasion: 0,
            hull: 0,
            weapon_dmg: 0,
            shield_def: 0,
            n_clones: 1,
            weapon_ele1: "None",
            weapon_ele2: "None",
            shield_ele1: "None",
            shield_ele2: "None",
            vip_status: false,
            mob_name: "Brutes",
            mob_level: 1,
            n_fights: 1000,
            clone_modifiers: [
            { crit: 0, critdmg: 0, dual: 0 }
            ]
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('playerForm');
            const resultDiv = document.getElementById('playerResult');
            const submitBtn = document.getElementById('submitBtn');
            const cloneModifiersSection = document.getElementById('cloneModifiersSection');
            let cloneModifiers = [];
            
            // Declare totalStatPool for use after API import
            let totalStatPool = null;
            
            // Function to save all settings to localStorage
            function saveSettings() {
                const settings = {
                    // Player stats
                    power: form.power.value,
                    precision: form.precision.value,
                    evasion: form.evasion.value,
                    hull: form.hull.value,
                    available: form.available?.value || 0,
                    weapon_dmg: form.weapon_dmg.value,
                    shield_def: form.shield_def.value,
                    n_clones: form.n_clones.value,
                    weapon_ele1: form.weapon_ele1.value,
                    weapon_ele2: form.weapon_ele2.value,
                    shield_ele1: form.shield_ele1.value,
                    shield_ele2: form.shield_ele2.value,
                    vip_status: form.vip_status.checked,
                    // Mob settings
                    mob_name: form.mob_name.value,
                    mob_level: form.mob_level.value,
                    // Squadron buffs
                    income_boost: form.income_boost?.value || 0,
                    battle_boost: form.battle_boost?.value || 0,
                    reputation: form.reputation?.value || 0,
                    // Clone modifiers
                    clone_modifiers: cloneModifiers,
                    // Resources calculator
                    resources_per_action: document.getElementById('resources_per_action').value,
                    rare_resources_per_action: document.getElementById('rare_resources_per_action').value,
                    number_of_drones: document.getElementById('number_of_drones').value,
                    dodge_percentage: document.getElementById('dodge_percentage').value,
                    rare_drop_increase: document.getElementById('rare_drop_increase').value,
                    maneuverability: document.getElementById('maneuverability').value,
                    // Optimizer settings
                    optimizer_target: document.querySelector('input[name="optimize_target"]:checked').value,
                    optimizer_htk: document.getElementById('optimizer_htk').value,
                    optimizer_htd: document.getElementById('optimizer_htd').value,
                    // API key
                    api_key: form.api_key?.value || ''
                };
                localStorage.setItem('stellarOdysseySettings', JSON.stringify(settings));
            }
            
            // Load saved settings or use defaults
            const savedSettings = localStorage.getItem('stellarOdysseySettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                Object.entries(settings).forEach(([key, value]) => {
                    if (key === 'clone_modifiers') {
                        cloneModifiers = value;
                    } else if (key === 'optimizer_target') {
                        const radio = document.querySelector(`input[name="optimize_target"][value="${value}"]`);
                        if (radio) radio.checked = true;
                    } else {
                        const el = document.getElementById(key);
                        if (!el) return;
                        if (el.type === "checkbox") {
                            el.checked = !!value;
                        } else if (el.type === "select-one") {
                            el.value = value || "";
                        } else {
                            el.value = value;
                        }
                    }
                });
                // Render clone modifiers with saved values
                renderCloneModifiers(parseInt(settings.n_clones) || 1);
            } else {
                // Apply DEFAULTS to form fields
                Object.entries(DEFAULTS).forEach(([key, value]) => {
                    const el = document.getElementById(key);
                    if (!el) return;
                    if (el.type === "checkbox") {
                        el.checked = !!value;
                    } else if (el.type === "select-one") {
                        el.value = value || "";
                    } else {
                        el.value = value;
                    }
                });
                cloneModifiers = DEFAULTS.clone_modifiers.map(mod => ({...mod}));
                renderCloneModifiers(parseInt(DEFAULTS.n_clones) || 1);
            }
            
            // For selects and n_clones, trigger input event to update UI
            const nClonesInput = document.getElementById('n_clones');
            nClonesInput.addEventListener('input', () => {
                let n = Math.min(Math.max(parseInt(nClonesInput.value) || 1, 1), 10);
                nClonesInput.value = n;
                if (cloneModifiers.length > n) {
                    cloneModifiers = cloneModifiers.slice(0, n);
                } else if (cloneModifiers.length < n) {
                    while (cloneModifiers.length < n) {
                        cloneModifiers.push({ crit: 0.0, critdmg: 0.0, dual: 0.0 });
                    }
                }
                renderCloneModifiers(n);
                saveSettings();
            });
            
            function renderCloneModifiers(n) {
                // Always use cloneModifiers.length as the source of truth
                cloneModifiersSection.innerHTML = '';
                for (let i = 0; i < cloneModifiers.length; i++) {
                    const block = document.createElement('div');
                    block.className = 'clone-modifiers-block';
                    block.innerHTML = `
                        <div class="clone-label">Clone ${i+1}</div>
                        <div class="clone-field-group">
                            <label>Crit. Chance</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="crit">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].crit}" class="clone-input" data-clone="${i}" data-field="crit">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="crit">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>Crit. Damage</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="critdmg">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].critdmg}" class="clone-input" data-clone="${i}" data-field="critdmg">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="critdmg">+</button>
                        </div>
                        <div class="clone-field-group">
                            <label>Dual Shot</label>
                            <button type="button" class="minus-btn" data-clone="${i}" data-field="dual">-</button>
                            <input type="number" step="0.1" min="0" max="100" value="${cloneModifiers[i].dual}" class="clone-input" data-clone="${i}" data-field="dual">%
                            <button type="button" class="plus-btn" data-clone="${i}" data-field="dual">+</button>
                        </div>
                    `;
                    cloneModifiersSection.appendChild(block);
                }
                // Attach event listeners for new buttons and inputs
                const modifyAll = document.getElementById('modifyAllClones')?.checked;
                cloneModifiersSection.querySelectorAll('.minus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.max(0, (parseFloat(cloneModifiers[idx][field]) || 0) - 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.plus-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.getAttribute('data-clone'));
                        const field = btn.getAttribute('data-field');
                        let newVal = Math.min(100, (parseFloat(cloneModifiers[idx][field]) || 0) + 1);
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = newVal;
                        } else {
                            cloneModifiers[idx][field] = newVal;
                        }
                        renderCloneModifiers(cloneModifiers.length);
                        saveSettings();
                    });
                });
                cloneModifiersSection.querySelectorAll('.clone-input').forEach(input => {
                    input.addEventListener('input', () => {
                        const idx = parseInt(input.getAttribute('data-clone'));
                        const field = input.getAttribute('data-field');
                        let val = parseFloat(input.value) || 0;
                        if (val < 0) val = 0;
                        if (val > 100) val = 100;
                        if (document.getElementById('modifyAllClones')?.checked) {
                            for (let j = 0; j < cloneModifiers.length; j++) cloneModifiers[j][field] = val;
                            renderCloneModifiers(cloneModifiers.length);
                        } else {
                            cloneModifiers[idx][field] = val;
                        }
                        saveSettings();
                    });
                });
            }
            
            // Handle plus/minus for player fields
            document.querySelectorAll('.minus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const min = parseFloat(input.getAttribute('min')) || 0;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones', 'optimizer_htk', 'optimizer_htd'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion'].includes(targetId)) {
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'battle_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.max(min, val - step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'battle_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });
            
            document.querySelectorAll('.plus-btn:not([data-clone])').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const max = parseFloat(input.getAttribute('max')) || Infinity;
                    let val = parseFloat(input.value) || 0;
                    
                    // Define step values for different fields
                    let step = 10; // default step
                    if (['n_clones', 'number_of_drones', 'optimizer_htk', 'optimizer_htd'].includes(targetId)) {
                        step = 1;
                    } else if (['precision', 'hull', 'power', 'evasion'].includes(targetId)) {
                        step = 5;
                    } else if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'battle_boost', 'reputation'].includes(targetId)) {
                        step = 1;
                    }
                    
                    val = Math.min(max, val + step);
                    // Round to 1 decimal place for percentage fields
                    if (['dodge_percentage', 'rare_drop_increase', 'maneuverability', 'income_boost', 'battle_boost', 'reputation'].includes(targetId)) {
                        val = Math.round(val * 10) / 10;
                    }
                    input.value = val;
                    input.dispatchEvent(new Event('input'));
                });
            });
            
            // Simulate button logic
            const simulateBtn = document.getElementById('simulateBtn');
            const battleResultDiv = document.createElement('div');
            battleResultDiv.id = 'battleResult';
            simulateBtn.parentNode.parentNode.parentNode.appendChild(battleResultDiv);
            simulateBtn.addEventListener('click', () => {
                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                const available = parseInt(form.available.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;
                
                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                new CloneModifiers(
                (parseFloat(mod.crit) || 0) / 100,
                (parseFloat(mod.critdmg) || 0) / 100,
                (parseFloat(mod.dual) || 0) / 100
                )
                );
                
                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                // MobName enum is uppercase keys
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);
                
                // Number of fights
                let n_fights = parseInt(form.n_fights.value) || 1000;
                if (n_fights < 1) n_fights = 1;
                if (n_fights > 1000000) {
                    n_fights = 1000000;
                    form.n_fights.value = 1000000;
                }
                
                // Create player
                const battle_boost = (parseInt(form.battle_boost?.value || 0) * 0.02);
                const player = new Player({
                    power, precision, evasion, hull, available: parseInt(document.getElementById('available').value) || 0, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2, battle_boost
                });
                
                // Create and run battle
                const battle = new Battle({ player, mob, list_modifiers, verbose: false });
                const win_chance = battle.repeat_fights(n_fights);
                
                // Get income boost and reputation values
                const income_boost = (parseInt(form.income_boost?.value || 0) * 0.02);
                const reputation = (parseFloat(form.reputation?.value || 0) / 100);
                
                // Print result
                const creditsPerHour = battle.get_revenue('hourly', win_chance, income_boost, reputation);
                const creditsPerDay = battle.get_revenue('daily', win_chance, income_boost, reputation);
                const expPerHour = battle.get_experience('hourly', win_chance, reputation);
                const expPerDay = battle.get_experience('daily', win_chance, reputation);
                battleResultDiv.innerHTML = `<b>Win chance:</b> ${(win_chance * 100).toFixed(2)}%<br>` +
                `<b>Credits per hour:</b> ${millify(creditsPerHour)}/h<br>` +
                `<b>Credits per day:</b> ${millify(creditsPerDay)}/day<br>` +
                `<b>Experience per hour:</b> ${millify(expPerHour)}/h<br>` +
                `<b>Experience per day:</b> ${millify(expPerDay)}/day`;
            });
            
            // Optimizer logic
            const optimizerBtn = document.getElementById('optimizerBtn');
            const longOptimizerBtn = document.getElementById('longOptimizerBtn');
            const optimizerResultDiv = document.getElementById('optimizerResult');
            
            async function runOptimizer(isLongOptimize = false) {

                // Loads Optimized worker amount from localStorage.
                function getRecommendedWorkerCount() {
                    const defaultCores = navigator.hardwareConcurrency || 4;
                    const defaultSafe = Math.max(1, Math.floor(defaultCores / 2));
                    const saved = localStorage.getItem("optimizer_maxWorkers");
                    return saved ? parseInt(saved, 10) : defaultSafe;
                }

                let blockedFrames = 0;
                let blockThreshold = 200;

                // CPU cost and blocking monitor.
                function monitorBlocking() {
                    let lastTime = performance.now();
                    const check = () => {
                        const now = performance.now();
                        const delay = now - lastTime;
                        if (delay > blockThreshold) {
                            blockedFrames++;
                        }
                        lastTime = now;
                        requestAnimationFrame(check);
                    };
                    requestAnimationFrame(check);
                }
                monitorBlocking();

                // Reset progress bar
                const progressBar = document.getElementById('optimizerProgressBar');
                const progressText = document.getElementById('optimizerProgressText');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                
                // Gather player fields
                const power = parseInt(form.power.value) || 0;
                const precision = parseInt(form.precision.value) || 0;
                const evasion = parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                const weapon_dmg = parseInt(form.weapon_dmg.value) || 0;
                const shield_def = parseInt(form.shield_def.value) || 0;
                const n_clones = parseInt(form.n_clones.value) || 1;
                const weapon_ele1 = form.weapon_ele1.value || null;
                const weapon_ele2 = form.weapon_ele2.value || null;
                const shield_ele1 = form.shield_ele1.value || null;
                const shield_ele2 = form.shield_ele2.value || null;
                const vip_status = form.vip_status.checked;
                
                // Gather clone modifiers
                const list_modifiers = cloneModifiers.map(mod =>
                new CloneModifiers(
                (parseFloat(mod.crit) || 0) / 100,
                (parseFloat(mod.critdmg) || 0) / 100,
                (parseFloat(mod.dual) || 0) / 100
                )
                );
                
                // Gather mob fields
                const mob_name = form.mob_name.value;
                const mob_level = parseInt(form.mob_level.value) || 1;
                let mob_enum_key = Object.keys(MobName).find(key => MobName[key] === mob_name);
                const mob = new Mob(MobName[mob_enum_key], mob_level);
                
                // Create player
                const battle_boost = (parseInt(form.battle_boost?.value || 0) * 0.05);
                const player = new Player({
                    power, precision, evasion, hull, available: parseInt(document.getElementById('available').value) || 0, weapon_dmg, shield_def, n_clones, vip_status,
                    weapon_ele1, weapon_ele2, shield_ele1, shield_ele2, battle_boost
                });
                
                const optimizerFightsInput = document.getElementById('optimizer_n_fights');
                const n_fights = parseInt(optimizerFightsInput.value);
                const reputation = (parseFloat(form.reputation?.value || 0) / 100);
                const optimizer = new Optimizer(player, mob, list_modifiers, n_fights, reputation);
                let result;
                
                if (isLongOptimize) {
                    const usedThreads = getRecommendedWorkerCount();
                    const pool = new WorkerPool(usedThreads);
                    const target = document.querySelector('input[name="optimize_target"]:checked').value;
                    // Utility function to create a range [start, end] 
                    function range(start, end) {
                        return Array.from({length: end - start + 1}, (_, i) => i + start);
                    }
                    const range_htk = range(3, 16);
                    const range_htd = range(2, 8);
                    const totalTasks = range_htk.length * range_htd.length;
                    let completedTasks = 0;
                    
                    const optimizer = new Optimizer(player, mob, list_modifiers, n_fights, reputation);
                    const optimizerData = optimizer.serialize();
                    
                    const tasks = [];
                    for (const htk of range_htk) {
                        for (const htd of range_htd) {
                            tasks.push({
                                optimizerData,
                                target,
                                htd,
                                htk
                            });
                        }
                    }
                    
                    //Update progress with finished tasks count.
                    const updateProgress = () => {
                        completedTasks++;
                        const progress = (completedTasks / totalTasks) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                    };
                    
                    try {
                        const results = await Promise.all(tasks.map(task => {
                            return pool.runTask(task)
                            .then(result => {
                                updateProgress();
                                return result;
                            });
                        }));
                        
                        let bestResult = results[0];
                        for (const resultone of results) {
                            if (resultone.res > bestResult.res) {
                                bestResult = resultone;
                            }
                        }
                        
                        //bestResult construct from optimizer.js
                        let {
                            build: best_build,
                            res: best_res,
                            win_chance: best_win_chance,
                            htd: best_htd,
                            htk: best_htk
                        } = bestResult;
                        
                        result = { bestStats: best_build, winChance: best_win_chance };
                        
                        document.getElementById('optimizer_htk').value = best_htk;
                        document.getElementById('optimizer_htd').value = best_htd;
                        
                        const settings = JSON.parse(localStorage.getItem('stellarOdysseySettings') || '{}');
                        settings.optimizer_htk = best_htk;
                        settings.optimizer_htd = best_htd;
                        localStorage.setItem('stellarOdysseySettings', JSON.stringify(settings));
                    } catch (error) {
                        console.error('Optimization error:', error);
                    } finally {
                        pool.terminate();
                        function evaluateAndSaveThreadSetting(usedThreads) {
                            console.log(`Blocked frames: ${blockedFrames}`);
                            const bad = blockedFrames > 5;
                            const good = blockedFrames < 2;

                            if (bad && usedThreads > 1) {
                                const next = usedThreads - 1;
                                console.warn(`⚠ Blocking Detected: Try using ${next} threads next time.`);
                                localStorage.setItem('optimizer_maxWorkers', next);
                            } else if (good && usedThreads < (navigator.hardwareConcurrency || 4)) {
                                const next = usedThreads + 1;
                                console.info(`✅ Flowing: Try using ${next} threads next time.`);
                                localStorage.setItem('optimizer_maxWorkers', next);
                            }
                        }
                        evaluateAndSaveThreadSetting(usedThreads);
                    }
                } else {
                    const target = document.querySelector('input[name="optimize_target"]:checked').value;
                    const htk = parseInt(document.getElementById('optimizer_htk').value);
                    const htd = parseInt(document.getElementById('optimizer_htd').value);
                    
                    // Simple smooth progress over exactly 1 second
                    const startTime = Date.now();
                    const duration = 1000; // 1 second
                    
                    const animateProgress = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration * 100, 100);
                        
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                        
                        if (progress < 100) {
                            requestAnimationFrame(animateProgress);
                        }
                    };
                    
                    requestAnimationFrame(animateProgress);
                    
                    const [bestBuild, bestRes, bestWinChance] = optimizer.findBestBuild(htd, htk, target, false);
                    result = { bestStats: bestBuild, winChance: bestWinChance };
                }
                
                // Update the results display
                if (result && result.bestStats && result.winChance !== undefined) {
                    const battle_boost = (parseInt(form.battle_boost?.value || 0) * 0.05);
                    const [power, precision, evasion, hull] = result.bestStats;
                    const tmp_player = new Player({
                        power,
                        precision,
                        evasion,
                        hull,
                        available: parseInt(document.getElementById('available').value) || 0,
                        weapon_dmg: player.weapon_dmg,
                        shield_def: player.shield_def,
                        n_clones: player.n_clones,
                        vip_status: player.vip_status,
                        weapon_ele1: player.weapon_ele1,
                        weapon_ele2: player.weapon_ele2,
                        shield_ele1: player.shield_ele1,
                        shield_ele2: player.shield_ele2,
                        battle_boost: battle_boost
                    });
                    const battle = new Battle({ player: tmp_player, mob: mob, list_modifiers: list_modifiers });
                    
                    // Get income boost and reputation values
                    const income_boost = (parseInt(form.income_boost?.value || 0) * 0.02);
                    const reputation = (parseFloat(form.reputation?.value || 0) / 100);
                    
                    const creditsPerHour = battle.get_revenue('hourly', result.winChance, income_boost, reputation);
                    const creditsPerDay = battle.get_revenue('daily', result.winChance, income_boost, reputation);
                    const expPerHour = battle.get_experience('hourly', result.winChance, reputation);
                    const expPerDay = battle.get_experience('daily', result.winChance, reputation);
                    
                    // Update the stats
                    document.getElementById('opt_power').textContent = power;
                    document.getElementById('opt_precision').textContent = precision;
                    document.getElementById('opt_evasion').textContent = evasion;
                    document.getElementById('opt_hull').textContent = hull;
                    
                    // Update the results
                    document.getElementById('opt_win_chance').textContent = `${(result.winChance * 100).toFixed(2)}%`;
                    document.getElementById('opt_credits_hour').textContent = `${millify(creditsPerHour)}/h`;
                    document.getElementById('opt_credits_day').textContent = `${millify(creditsPerDay)}/day`;
                    document.getElementById('opt_exp_hour').textContent = `${millify(expPerHour)}/h`;
                    document.getElementById('opt_exp_day').textContent = `${millify(expPerDay)}/day`;
                    
                    // Add Import button next to Optimize
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (!importBtn) {
                        importBtn = document.createElement('button');
                        importBtn.id = 'importOptimizedBtn';
                        importBtn.type = 'button';
                        importBtn.textContent = 'Import';
                        optimizerBtn.parentNode.insertBefore(importBtn, optimizerBtn.nextSibling);
                    }
                    importBtn.style.display = 'inline-block';
                    importBtn.onclick = () => {
                        form.power.value = power;
                        form.precision.value = precision;
                        form.evasion.value = evasion;
                        form.hull.value = hull;
                        updateUnallocatedStatsDisplay();
                    };
                } else {
                    // Reset all values to "-"
                    document.getElementById('opt_power').textContent = '-';
                    document.getElementById('opt_precision').textContent = '-';
                    document.getElementById('opt_evasion').textContent = '-';
                    document.getElementById('opt_hull').textContent = '-';
                    document.getElementById('opt_win_chance').textContent = '-';
                    document.getElementById('opt_credits_hour').textContent = '-';
                    document.getElementById('opt_credits_day').textContent = '-';
                    document.getElementById('opt_exp_hour').textContent = '-';
                    document.getElementById('opt_exp_day').textContent = '-';
                    
                    let importBtn = document.getElementById('importOptimizedBtn');
                    if (importBtn) importBtn.style.display = 'none';
                }
            }
            
            optimizerBtn.addEventListener('click', () => runOptimizer(false));
            longOptimizerBtn.addEventListener('click', () => runOptimizer(true));
            
            // Add event listeners to save settings when values change
            form.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', saveSettings);
                if (element.type === 'number' || element.type === 'text') {
                    element.addEventListener('input', saveSettings);
                }
            });
            
            // For number inputs, also save on input event for immediate feedback
            form.querySelectorAll('input[type="number"]').forEach(element => {
                element.addEventListener('input', saveSettings);
            });
            
            // Add event listeners for all minus/plus buttons
            document.querySelectorAll('.minus-btn, .plus-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    if (targetId) {
                        const input = document.getElementById(targetId);
                        if (input) {
                            input.dispatchEvent(new Event('input'));
                            saveSettings();
                        }
                    }
                });
            });
            
            // Modify the clone modifiers event listeners to save settings
            function addCloneModifierListeners() {
                cloneModifiersSection.querySelectorAll('.minus-btn, .plus-btn, .clone-input').forEach(element => {
                    element.addEventListener('change', saveSettings);
                    if (element.classList.contains('clone-input')) {
                        element.addEventListener('input', saveSettings);
                    }
                });
            }
            
            // Update the renderCloneModifiers function to add listeners
            const originalRenderCloneModifiers = renderCloneModifiers;
            renderCloneModifiers = function(n) {
                originalRenderCloneModifiers(n);
                addCloneModifierListeners();
            };
            
            
            // Add API import functionality
            const importBtn = document.getElementById('importBtn');
            const apiKeyInput = document.getElementById('api_key');
            
            async function fetchUserData(apiKey) {
                try {
                    const response = await axios({
                        method: 'get',
                        url: 'https://api.stellarodyssey.app/api/public/user',
                        headers: {
                            'Accept': 'application/json',
                            'sodyssey-api-key': apiKey
                        },
                        timeout: 5000
                    });
                    return response.data;
                } catch (error) {
                    let errorMessage = 'Failed to fetch user data. ';
                    
                    if (error.response) {
                        if (error.response.status === 401) {
                            errorMessage += 'Invalid API key.';
                        } else if (error.response.status === 404) {
                            errorMessage += 'User not found.';
                        } else {
                            errorMessage += `Server responded with status ${error.response.status}.`;
                        }
                    } else if (error.code === 'ECONNABORTED') {
                        errorMessage += 'Request timed out.';
                    } else if (error.code === 'ERR_NETWORK') {
                        if (error.message.includes('CORS')) {
                            errorMessage += 'CORS error: The API server is not configured to allow requests from this domain. Please contact the API administrators.';
                        } else {
                            errorMessage += 'Network error. Please check your internet connection.';
                        }
                    } else {
                        errorMessage += error.message;
                    }
                    
                    throw new Error(errorMessage);
                }
            }
            
            function updateFormWithUserData(userData) {
                const data = userData.data;
                
                // Update form fields with API data
                if (data.stats) {
                    form.power.value = data.stats.power || 0;
                    form.precision.value = data.stats.precision || 0;
                    form.evasion.value = data.stats.evasion || 0;
                    form.hull.value = data.stats.hull || 0;
                    document.getElementById('available').value = data.stats.available || 0;
                    
                    // Set the total stat pool
                    totalStatPool =
                    (parseInt(form.power.value) || 0) +
                    (parseInt(form.precision.value) || 0) +
                    (parseInt(form.evasion.value) || 0) +
                    (parseInt(form.hull.value) || 0) +
                    (parseInt(document.getElementById('available').value) || 0);
                    
                    updateUnallocatedStatsDisplay()
                }
                
                // Update ship data
                if (data.ship) {
                    if (data.ship.weapon) {
                        form.weapon_dmg.value = data.ship.weapon.value || 0;
                        if (data.ship.weapon.bonuses && data.ship.weapon.bonuses.length > 0) {
                            form.weapon_ele1.value = data.ship.weapon.bonuses[0].charAt(0).toUpperCase() + data.ship.weapon.bonuses[0].slice(1);
                            if (data.ship.weapon.bonuses.length > 1) {
                                form.weapon_ele2.value = data.ship.weapon.bonuses[1].charAt(0).toUpperCase() + data.ship.weapon.bonuses[1].slice(1);
                            } else {
                                form.weapon_ele2.value = '';
                            }
                        } else {
                            form.weapon_ele1.value = '';
                            form.weapon_ele2.value = '';
                        }
                    }
                    
                    if (data.ship.shield) {
                        form.shield_def.value = data.ship.shield.value || 0;
                        if (data.ship.shield.bonuses && data.ship.shield.bonuses.length > 0) {
                            form.shield_ele1.value = data.ship.shield.bonuses[0].charAt(0).toUpperCase() + data.ship.shield.bonuses[0].slice(1);
                            if (data.ship.shield.bonuses.length > 1) {
                                form.shield_ele2.value = data.ship.shield.bonuses[1].charAt(0).toUpperCase() + data.ship.shield.bonuses[1].slice(1);
                            } else {
                                form.shield_ele2.value = '';
                            }
                        } else {
                            form.shield_ele1.value = '';
                            form.shield_ele2.value = '';
                        }
                    }
                }
                
                // Update VIP status
                form.vip_status.checked = data.premium || false;
                
                // Update number of clones and clone modifiers
                if (data.clones && data.clones.length > 0) {
                    form.n_clones.value = data.clones.length;
                    cloneModifiers = data.clones.map(clone => ({
                        crit: clone.critical_chance || 0,
                        critdmg: clone.critical_damage || 0,
                        dual: clone.dual_shot || 0
                    }));
                }
                
                // Update current mob and level
                if (data.actions) {
                    if (data.actions.currentNpc) {
                        form.mob_name.value = data.actions.currentNpc.charAt(0).toUpperCase() + data.actions.currentNpc.slice(1);
                    }
                    if (data.actions.currentNpcLevel) {
                        form.mob_level.value = data.actions.currentNpcLevel;
                    }
                }
                
                // Handle spacestation battleboost
                if (data.spacestation && data.spacestation.battling_boost) {
                    form.battle_boost.value = data.spacestation.battling_boost;
                } else {
                    form.battle_boost.value = 0;
                }
                
                // Handle spacestation incomeboost
                if (data.spacestation && data.spacestation.incomeboost) {
                    form.income_boost.value = data.spacestation.incomeboost;
                } else {
                    form.income_boost.value = 0;
                }
                
                // Handle reputation
                if (data.reputation !== null && data.reputation !== undefined) {
                    form.reputation.value = data.reputation;
                } else {
                    form.reputation.value = 0;
                }
                
                // Render clone modifiers with the new data
                renderCloneModifiers(parseInt(form.n_clones.value) || 1);
                
                const nClonesInput = document.getElementById('n_clones');
                nClonesInput.dispatchEvent(new Event('input'));
                
                saveSettings();
            }
            
            importBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('Please enter your API key');
                    return;
                }
                
                try {
                    importBtn.disabled = true;
                    importBtn.textContent = 'Importing...';
                    
                    const userData = await fetchUserData(apiKey);
                    updateFormWithUserData(userData);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import';
                } catch (error) {
                    alert(error.message);
                    
                    importBtn.disabled = false;
                    importBtn.textContent = 'Import';
                }
            });
            
            // --- Unallocated stats logic ---
            function updateUnallocatedStatsDisplay() {
                const power = parseInt(form.power.value) || 0;
                const precision =  parseInt(form.precision.value) || 0;
                const evasion =  parseInt(form.evasion.value) || 0;
                const hull = parseInt(form.hull.value) || 0;
                if (totalStatPool === null) {
                    totalStatPool =
                    (parseInt(form.power.value) || 0) +
                    (parseInt(form.precision.value) || 0) +
                    (parseInt(form.evasion.value) || 0) +
                    (parseInt(form.hull.value) || 0);
                    document.getElementById('unallocatedStatsDisplay').textContent = `Unallocated stats: 0`;
                }
                else {
                    const unallocated = totalStatPool - (power + precision + evasion + hull)
                    document.getElementById('unallocatedStatsDisplay').textContent = `Unallocated stats: ${unallocated}`;
                }
            }
            
            ['power','precision','evasion','hull'].forEach(stat => {
                const input = document.getElementById(stat);
                input.addEventListener('input', () => {
                    updateUnallocatedStatsDisplay();
                });
            });
            
            // On page load, initialize lastStats and display
            updateUnallocatedStatsDisplay();
            // --- End unallocated stats logic ---
        });
        
    </script>
</head>
<body>
    <div style="display: flex; align-items: center; gap: 1em; margin-bottom: 2.2em;">
        <div style="font-size: 1.7em; font-weight: 600; letter-spacing: 0.01em;">Stellar Odyssey Simulator and Optimizer</div>
    </div>
    <!-- Tab content sections -->
    <div id="battling-tab" class="tab-content active">
        <form id="playerForm" class="form-section" autocomplete="off" style="display: flex; flex-direction: row; gap: 2em;">
            <div style="flex: 3;">
                <div class="player-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label" style="display: flex; align-items: center; justify-content: flex-start;">
                        <span>Player</span>
                        <span id="unallocatedStatsDisplay" class="player-unallocated-label">Unallocated stats: 0</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="power">Power:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="power">-</button>
                                <input type="number" id="power" name="power" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="power">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="precision">Precision:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="precision">-</button>
                                <input type="number" id="precision" name="precision" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="precision">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="evasion">Evasion:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="evasion">-</button>
                                <input type="number" id="evasion" name="evasion" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="evasion">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="hull">Hull:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="hull">-</button>
                                <input type="number" id="hull" name="hull" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="hull">+</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="available" name="available" value="0">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weapon_dmg">Weapon damage:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="weapon_dmg">-</button>
                                <input type="number" id="weapon_dmg" name="weapon_dmg" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="weapon_dmg">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="shield_def">Shield Defense:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="shield_def">-</button>
                                <input type="number" id="shield_def" name="shield_def" value="0" min="0">
                                <button type="button" class="plus-btn" data-target="shield_def">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="weapon_ele1">Weapon Modification 1:</label>
                            <select id="weapon_ele1" name="weapon_ele1">
                                <option value="">None</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Electromagnetic">Electromagnetic</option>
                                <option value="Energy">Energy</option>
                                <option value="Explosive">Explosive</option>
                                <option value="Incendiary">Incendiary</option>
                                <option value="Kinetic">Kinetic</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weapon_ele2">Weapon Modification 2:</label>
                            <select id="weapon_ele2" name="weapon_ele2">
                                <option value="">None</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Electromagnetic">Electromagnetic</option>
                                <option value="Energy">Energy</option>
                                <option value="Explosive">Explosive</option>
                                <option value="Incendiary">Incendiary</option>
                                <option value="Kinetic">Kinetic</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shield_ele1">Shield Modification 1:</label>
                            <select id="shield_ele1" name="shield_ele1">
                                <option value="">None</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Electromagnetic">Electromagnetic</option>
                                <option value="Energy">Energy</option>
                                <option value="Explosive">Explosive</option>
                                <option value="Incendiary">Incendiary</option>
                                <option value="Kinetic">Kinetic</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="shield_ele2">Shield Modification 2:</label>
                            <select id="shield_ele2" name="shield_ele2">
                                <option value="">None</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Electromagnetic">Electromagnetic</option>
                                <option value="Energy">Energy</option>
                                <option value="Explosive">Explosive</option>
                                <option value="Incendiary">Incendiary</option>
                                <option value="Kinetic">Kinetic</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="n_clones">Number of Clones:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="n_clones">-</button>
                                <input type="number" id="n_clones" name="n_clones" value="1" min="1" max="10">
                                <button type="button" class="plus-btn" data-target="n_clones">+</button>
                            </div>
                        </div>
                        <div class="form-group" style="align-items: flex-start; justify-content: flex-end;">
                            <label for="vip_status" style="margin-bottom: 0;">
                                <input type="checkbox" id="vip_status" name="vip_status">
                                VIP Status
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label">Mob</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mob_name">Mob Name:</label>
                            <select id="mob_name" name="mob_name">
                                <option value="Brutes">Brutes</option>
                                <option value="Dusters">Dusters</option>
                                <option value="Machiners">Machiners</option>
                                <option value="Toxoids">Toxoids</option>
                                <option value="Scorchers">Scorchers</option>
                                <option value="Glacials">Glacials</option>
                                <option value="Spectres">Spectres</option>
                                <option value="Miners">Miners</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mob_level">Level:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="mob_level">-</button>
                                <input type="number" id="mob_level" name="mob_level" value="1" min="1">
                                <button type="button" class="plus-btn" data-target="mob_level">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mob-block" style="width: 420px; min-width: 420px; max-width: 420px;">
                    <div class="block-label">Squadron Buffs</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="battle_boost">Battle Boost Level:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="battle_boost">-</button>
                                <input type="number" id="battle_boost" name="battle_boost" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <button type="button" class="plus-btn" data-target="battle_boost">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="income_boost">Income Boost Level:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="income_boost">-</button>
                                <input type="number" id="income_boost" name="income_boost" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                <button type="button" class="plus-btn" data-target="income_boost">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reputation">Reputation:</label>
                            <div class="input-group">
                                <button type="button" class="minus-btn" data-target="reputation">-</button>
                                <input type="number" id="reputation" name="reputation" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">%
                                <button type="button" class="plus-btn" data-target="reputation">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; flex-direction: row; align-items: flex-start;">
                <div style="position: relative; width: fit-content;">
                    <div style="position: absolute; left: 180px; top: -2.1em; z-index: 2;">
                        <label style="font-size: 1.08em; display: flex; align-items: center; color: #e6eaf3; background: #23283a; padding: 0.1em 0.7em 0.1em 0.5em; border-radius: 5px; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);">
                            <input type="checkbox" id="modifyAllClones" style="margin-right: 0.5em;"> Modify all clones together
                        </label>
                    </div>
                    <div id="cloneModifiersSection" class="clone-modifiers-section"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 7.5em;">
                    <div class="api-block" style="margin-top: 0; margin-left: 5px; min-height: 110px; max-height: 110px; width: 450px; min-width: 450px; max-width: 450px; background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 0.7em 1.2em 0.5em 1.2em; box-sizing: border-box;">
                        <div class="block-label">Import data
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Import your player, mob and clone stats using your API key. This will automatically fill in all your current stats. Your API key is located in Settings">ⓘ</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="api_key">API Key:</label>
                                <input type="text" id="api_key" name="api_key" style="width: 150%; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em;">
                            </div>
                            <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 110px;">
                                <button id="importBtn" type="button">Import</button>
                            </div>
                        </div>
                    </div>
                    <div class="battle-block" style="margin-top: 1.0em; margin-left: 5px; min-height: 210px; max-height: 210px;width: 350px; min-width: 350px; max-width: 350px">
                        <div class="block-label">Battle Simulation
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Run a battle simulation with the current configuration. The simulation will execute the specified number of battles (up to 1,000,000) to calculate win probability and resource gains.">ⓘ</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="n_fights">Number of fights:</label>
                                <input type="number" id="n_fights" name="n_fights" value="10000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            </div>
                            <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: -30px;">
                                <button id="simulateBtn" type="button">Simulate</button>
                            </div>
                        </div>
                    </div>
                    <div class="optimizer-block" style="margin-top: 1.5em; margin-left: 5px; width: 600px; min-width: 600px; max-width: 600px; min-height: 210px;">
                        <div class="block-label">Optimizer
                            <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Find the optimal stat distribution for your current configuration. The optimizer will test various stat combinations using the specified number of simulations (up to 1,000,000). Higher values provide more accurate results but significantly increase computation time and may temporarily freeze the interface. Consider starting with a lower number and increasing it if needed.">ⓘ</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 1em;">
                            <span style="margin-right: 10px;">Optimize against:</span>
                            <label style="margin-right: 15px; display: flex; align-items: center;">
                                <input type="radio" name="optimize_target" value="credits" checked style="margin-right: 5px;"> Credits
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="optimize_target" value="exp" style="margin-right: 5px;"> Experience
                            </label>
                        </div>
                        <div class="form-row" style="margin-bottom: 1em;">
                            <div class="form-group">
                                <label for="optimizer_htk">HTK:
                                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Hits to kill: The number of hits needed to defeat the mob">ⓘ</span>
                                </label>
                                <div class="input-group">
                                    <button type="button" class="minus-btn" data-target="optimizer_htk">-</button>
                                    <input type="number" id="optimizer_htk" name="optimizer_htk" value="8" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                    <button type="button" class="plus-btn" data-target="optimizer_htk">+</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="optimizer_htd">HTD:
                                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Hits to die: The number of hits the mob needs to defeat your clones">ⓘ</span>
                                </label>
                                <div class="input-group">
                                    <button type="button" class="minus-btn" data-target="optimizer_htd">-</button>
                                    <input type="number" id="optimizer_htd" name="optimizer_htd" value="4" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                                    <button type="button" class="plus-btn" data-target="optimizer_htd">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="optimizer_n_fights">Number of fights:</label>
                                <input type="number" id="optimizer_n_fights" name="optimizer_n_fights" value="5000" min="1" max="1000000" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            </div>
                            <div class="form-group" style="display: flex; flex-direction: row; align-items: center; margin-left: -250px;">
                                <button id="optimizerBtn" type="button" style="margin-right: 10px;">Simple Optimize</button>
                                <button id="longOptimizerBtn" type="button" style="margin-right: 10px;" title="Optimize by searching through multiple values of HTK and HTD. It is not advised to use more than 5000 fights">Long Optimize</button>
                                <button id="importOptimizedBtn" type="button" style="display: none;">Import</button>
                            </div>
                        </div>
                        <div id="optimizerProgress" style="height: 50px; margin: 1em 0;">
                            <div style="width: 100%; background: #36405a; border-radius: 4px; height: 20px; overflow: hidden;">
                                <div id="optimizerProgressBar" style="width: 0%; height: 100%; background: #4fa3ff; transition: width 0.3s ease;"></div>
                            </div>
                            <div id="optimizerProgressText" style="text-align: center; margin-top: 0.5em; font-size: 0.9em; color: #b0b6c6;">0%</div>
                        </div>
                        <div id="optimizerResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.2em 1.2em; width: 140px; font-size: 1em;">
                                <div><b>Power</b><br><span id="opt_power">-</span></div>
                                <div><b>Precision</b><br><span id="opt_precision">-</span></div>
                                <div><b>Evasion</b><br><span id="opt_evasion">-</span></div>
                                <div><b>Hull</b><br><span id="opt_hull">-</span></div>
                            </div>
                            <div style="font-size: 0.98em;">
                                <div><b>Win chance:</b> <span id="opt_win_chance">-</span></div>
                                <div><b>Credits per hour:</b> <span id="opt_credits_hour">-</span></div>
                                <div><b>Credits per day:</b> <span id="opt_credits_day">-</span></div>
                                <div><b>Experience per hour:</b> <span id="opt_exp_hour">-</span></div>
                                <div><b>Experience per day:</b> <span id="opt_exp_day">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div id="gathering-tab" class="tab-content">
        <div class="form-section" style="display: flex; flex-direction: row; gap: 2em;">
            <div class="optimizer-block" style="margin-top: 1.0em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px; position: relative;">
                <div style="position: absolute; top: 0.5em; right: 1em; text-align: left; font-size: 0.75em; color: #b0b6c6; line-height: 1.2;">
                    For a more precise resources<br>
                    calculator, see this <a href="https://docs.google.com/spreadsheets/d/1DCpkdBsHL_dqa_Fv13k3M1iKVuBCa4vXbfTjToQ64G8/edit?gid=1892479921#gid=1892479921" target="_blank" style="color: #4fa3ff; text-decoration: none;">Google Sheet</a>
                </div>
                <div class="block-label">Resources Calculator
                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Calculate resource gathering rates and time to reach specific goals based on your current setup.
                    • 'Resources' and 'Rare resources' per action refer to what you are currently gathering on your current planet
                    • 'Additional dodge' and 'Additional rare resource drop' depend only on Laser and Sensor modifications
                    • 'Avg. maneuverability' is the average Maneuverability across all your drones">ⓘ</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="resources_per_action">Resources per action:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="resources_per_action">-</button>
                            <input type="number" id="resources_per_action" name="resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="resources_per_action">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rare_resources_per_action">Rare res per action:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="rare_resources_per_action">-</button>
                            <input type="number" id="rare_resources_per_action" name="rare_resources_per_action" value="0" min="0" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="rare_resources_per_action">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="number_of_drones">Number of drones:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="number_of_drones">-</button>
                            <input type="number" id="number_of_drones" name="number_of_drones" value="1" min="1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <button type="button" class="plus-btn" data-target="number_of_drones">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dodge_percentage">Additional dodge:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="dodge_percentage">-</button>
                            <input type="number" id="dodge_percentage" name="dodge_percentage" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="dodge_percentage">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="rare_drop_increase">Additional rare res drop:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="rare_drop_increase">-</button>
                            <input type="number" id="rare_drop_increase" name="rare_drop_increase" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="rare_drop_increase">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="maneuverability">Avg. maneuverability:</label>
                        <div class="input-group">
                            <button type="button" class="minus-btn" data-target="maneuverability">-</button>
                            <input type="number" id="maneuverability" name="maneuverability" value="0" min="0" max="100" step="0.1" style="width: 5.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                            <span style="margin: 0 0.2em;">%</span>
                            <button type="button" class="plus-btn" data-target="maneuverability">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="align-items: flex-start; justify-content: flex-start; margin-left: 0;">
                        <button id="calculateResourcesBtn" type="button">Calculate</button>
                    </div>
                </div>
                <div id="resourcesResult" style="display: flex; flex-direction: row; gap: 2em; margin-top: 1em;">
                    <div style="font-size: 0.98em;">
                        <div><b>Resources per hour:</b> <span id="resources_per_hour">-</span></div>
                        <div><b>Rare resources per hour:</b> <span id="rare_resources_per_hour">-</span></div>
                        <div><b>Hours necessary to gather 32M resources:</b> <span id="hours_to_32m">-</span></div>
                        <div><b>Hours necessary to gather 800k rare resources:</b> <span id="days_to_800k">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="universe-map-tab" class="tab-content">
        <div style="display: flex; flex-direction: row; padding: 2em; gap: 2em; height: 720px;">
            <div style="display: flex; flex-direction: column; gap: 1em; min-width: 400px; max-width: 400px; margin-top: 37vh; transform: translateY(-50%);">
                <div style="background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 1.2em; box-sizing: border-box;">
                    <div style="font-size: 1.22em; font-weight: 700; margin-bottom: 1em; color: #f3f6fa; letter-spacing: 0.01em;">Discovered Universe</div>
                    <div style="display: flex; flex-direction: column; gap: 1em;">
                        <div>
                            <label for="systems_api_key" style="display: block; margin-bottom: 0.5em; color: #e6eaf3;">API Key:</label>
                            <input type="text" id="systems_api_key" style="width: 100%; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em; border-radius: 4px; box-sizing: border-box;">
                        </div>
                        <div style="color: #e6eaf3; font-size: 0.9em; margin-bottom: 0.0em;" id="systemsCount">There are currently 0 publicly discovered systems</div>
                        <div style="color: #e6eaf3; font-size: 0.9em; margin-bottom: 1.0em;" id="totalDistance">You have currently travelled a total of 0 ly</div>
                        <div style="display: flex; flex-direction: column; gap: 0.5em;">
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_public_systems" style="margin: 0;">
                                Show public systems
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_current_position" style="margin: 0;">
                                Show current position
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_player_journey" style="margin: 0;">
                                Show player journey
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5em; color: #e6eaf3; cursor: pointer;">
                                <input type="checkbox" id="show_space_stations" style="margin: 0;">
                                Show space stations and their region of influence
                            </label>
                        </div>
                        <button id="loadSystemsBtn" type="button" style="background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em 1em; border-radius: 4px; cursor: pointer; width: 100%;">Load Systems</button>
                    </div>
                </div>
            </div>

            <div style="position: relative; width: 720px; height: 720px; background: #181c24;">
                <canvas id="universeMap" style="width: 100%; height: 100%;"></canvas>
                <div id="ssBlock" style="position: absolute; right: -500px; top: 75px; width: 300px; background: #23283a; border-radius: 6px; border: 1px solid #2c3242; padding: 1.2em; color: #e6eaf3; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);">
                    <div class="block-label" style="margin-bottom: 1em;">Space Stations</div>
                    <div id="ssList"></div>
                    <div id="ssAddRow" style="display: flex; gap: 0.5em; align-items: center; margin-top: 1em;">
                        <button id="ssLoadBtn" type="button" style="margin-top: 1.5em; width: 100%; background: #36405a; color: #e6eaf3; border: none; border-radius: 4px; padding: 0.6em 0; font-weight: 600;">Load Space Stations</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="probabilities-tab" class="tab-content">
        <div class="form-section" style="display: flex; flex-direction: row; gap: 2em;">
            <div class="optimizer-block" style="margin-top: 1.0em; margin-left: 5px; width: 500px; min-width: 500px; max-width: 500px; min-height: 210px; max-height: 600px;">
                <div class="block-label">
                    System Occurrence Probability
                    <span style="color: #4fa3ff; margin-left: 5px; cursor: help;" title="Calculate the probability of observing a system with specific characteristics. This tool uses complex probability calculations involving multiple parameters (nodes, categories, qualities) and their interactions. Due to the mathematical complexity of these calculations, some results may require further refinement. The current implementation is being continuously improved for accuracy.">ⓘ</span>
                    <span style="color: #ff4f4f; margin-left: 5px; font-size: 0.8em; font-weight: normal;">beta</span>
                </div>
                <div class="form-row" style="margin-bottom: 1em;">
                    <div class="form-group">
                        <label for="inhabited_system" style="color: #e6eaf3;">System status:</label>
                        <select id="inhabited_system" name="inhabited_system" style="width: 12em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em; border-radius: 4px;">
                            <option value="any">Any</option>
                            <option value="inhabited">System is inhabited</option>
                            <option value="uninhabited">System is not inhabited</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_nodes">Number of nodes:</label>
                        <div class="input-group">
                            <select id="n_nodes_type" name="n_nodes_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">Exactly</option>
                                <option value="at least">At Least</option>
                                <option value="any">Any</option>
                            </select>
                            <input type="number" id="n_nodes" name="n_nodes" value="1" min="1" max="5" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_gatherable">Number of gathering nodes:</label>
                        <div class="input-group">
                            <select id="n_gatherable_type" name="n_gatherable_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">Exactly</option>
                                <option value="at least">At Least</option>
                                <option value="any">Any</option>
                            </select>
                            <input type="number" id="n_gatherable" name="n_gatherable" value="1" min="0" max="5" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="n_categories">Number of different categories:</label>
                        <div class="input-group">
                            <select id="n_categories_type" name="n_categories_type" style="width: 6em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; margin-right: 0.5em;">
                                <option value="exactly">Exactly</option>
                                <option value="at least">At Least</option>
                                <option value="any">Any</option>
                            </select>
                            <input type="number" id="n_categories" name="n_categories" value="1" min="1" max="4" style="width: 3.5em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242;">
                        </div>
                    </div>
                </div>
                <div id="quality-selections" style="margin-top: 0.5em; display: flex; flex-direction: column; gap: 0.3em;">
                    <div class="form-row" style="display: flex; align-items: center; gap: 0.5em; margin-bottom: 0;">
                        <label style="color: #e6eaf3; min-width: 180px;">Gathering node 1 quality:</label>
                        <select style="width: 8em; background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.2em; border-radius: 4px;">
                            <option value="any">Any</option>
                            <option value="1-30">1-30</option>
                            <option value="31-70">31-70</option>
                            <option value="71-90">71-90</option>
                            <option value="91-100">91-100</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1em; display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em;">
                    <button id="calculateProbabilityBtn" type="button" style="background: #36405a; color: #e6eaf3; border: 1px solid #2c3242; padding: 0.5em 1em; border-radius: 4px; cursor: pointer;">Calculate probability</button>
                    <div id="probabilityResult" style="color: #e6eaf3; font-size: 1.1em;">
                        <div>Probability: <span id="probability_value"></span></div>
                        <div>Estimated number of systems in the universe: <span id="estimated_systems"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab bar -->
    <div class="tab-container">
        <div class="tab active" data-tab="battling-tab">Battling</div>
        <div class="tab" data-tab="gathering-tab">Gathering</div>
        <div class="tab" data-tab="universe-map-tab">Universe Map</div>
        <div class="tab" data-tab="probabilities-tab">Probabilities</div>
    </div>
    
    <div id="playerResult"></div>
    <footer>
        <span>Proudly made by anfneub</span>
        <span style="margin-left: 2.5em;" id="lastUpdated"></span>
        <span style="margin-left: 2.5em;">Space Odyssey Version 1.2.1 2025-06-16</span>
        <span style="margin-left: 2.5em; cursor: pointer; color: #4fa3ff; text-decoration: underline;" id="changelogLink">Changelog</span>
    </footer>
    
    <!-- Add tab switching script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            // Function to switch tabs
            function switchTab(tab) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                // Save active tab to localStorage
                localStorage.setItem('activeTab', tabId);
                // Pause/resume universe map animation if needed
                if (typeof UniverseMap !== 'undefined' && UniverseMap.getInstance) {
                    if (tabId === 'universe-map-tab') {
                        UniverseMap.getInstance()?.resume?.();
                    } else {
                        UniverseMap.getInstance()?.pause?.();
                    }
                }
            }
            // Add click handlers to all tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
            });
            // Restore active tab from localStorage
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab) {
                const tabToActivate = document.querySelector(`.tab[data-tab="${savedTab}"]`);
                if (tabToActivate) {
                    switchTab(tabToActivate);
                }
            }
        });
    </script>
    <script>
        // Set last updated date/time
        const lastUpdated = document.getElementById('lastUpdated');
        if (lastUpdated) {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const dateStr = "2025-06-29";
            const timeStr = "18:59";
            lastUpdated.textContent = `Last updated: ${dateStr} ${timeStr}`;
        }
    </script>
    <!-- Changelog Modal -->
    <div id="changelogModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
        <div style="background:#222; color:#fff; padding:1.5em; border-radius:10px; max-width:650px; width:117vw; max-width:65vw; max-height:70vh; overflow:auto; box-shadow:0 4px 32px #000; position:relative;">
            <button id="closeChangelog" style="position:absolute; top:0.5em; right:0.5em; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
            <h2 style="margin-top:0;">Changelog</h2>
            <div id="changelogContent" style="white-space:pre-wrap; background:#181818; padding:1em; border-radius:6px; max-height:50vh; overflow:auto; font-size:1em; font-family:inherit;">Loading...</div>
        </div>
    </div>
    <script>
        document.getElementById('changelogLink').addEventListener('click', function() {
            const modal = document.getElementById('changelogModal');
            modal.style.display = 'flex';
            fetch('changelog.txt')
            .then(r => r.text())
            .then(txt => {
                // Format lines starting with '-' as list items
                const lines = txt.split('\n');
                let html = '';
                let inList = false;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (/^\s*- /.test(line)) {
                        if (!inList) { html += '<ul style="margin:0 0 0 1.5em; padding-left:1.2em;">'; inList = true; }
                            html += '<li style="margin-bottom:0.2em;">' + line.replace(/^\s*- /, '') + '</li>';
                        } else {
                            if (inList) { html += '</ul>'; inList = false; }
                            // If the line is not empty, wrap in <div>, else add a blank line
                                html += line.trim() ? '<div>' + line + '</div>' : '<div style="height:0.7em;"></div>';
                            }
                        }
                        if (inList) html += '</ul>';
                        document.getElementById('changelogContent').innerHTML = html;
                    })
                    .catch(() => {
                        document.getElementById('changelogContent').textContent = 'Could not load changelog.';
                    });
                });
                document.getElementById('closeChangelog').addEventListener('click', function() {
                    document.getElementById('changelogModal').style.display = 'none';
                });
                // Optional: close modal on outside click
                document.getElementById('changelogModal').addEventListener('click', function(e) {
                    if (e.target === this) this.style.display = 'none';
                });
            </script>
            <script src="script.js"></script>
            <script src="rhill-voronoi-core.min.js"></script>
            <script src="universe_map.js"></script>
            <script type="module">
                // Import probability functions
                import { probability_of_observation_with_per_gatherable_qualities } from './probabilities.js';
                
                document.addEventListener('DOMContentLoaded', function() {
                    // Declare variables at the top
                    const nNodesType = document.getElementById('n_nodes_type');
                    const nNodes = document.getElementById('n_nodes');
                    const nGatherableType = document.getElementById('n_gatherable_type');
                    const nGatherable = document.getElementById('n_gatherable');
                    const nCategoriesType = document.getElementById('n_categories_type');
                    const nCategories = document.getElementById('n_categories');
                    const qualitySelections = document.getElementById('quality-selections');
                    
                    // Quality ranges based on the probabilities.js file
                    const qualityRanges = [
                    { label: "1-30", value: "1-30" },
                    { label: "31-70", value: "31-70" },
                    { label: "71-90", value: "71-90" },
                    { label: "91-100", value: "91-100" }
                    ];
                    
                    function updateQualitySelections() {
                        const numGatherable = parseInt(nGatherable.value) || 0;
                        const isAny = nGatherableType.value === 'any';
                        
                        // Keep the first selection row
                        const firstSelection = qualitySelections.firstElementChild;
                        qualitySelections.innerHTML = '';
                        if (firstSelection) {
                            qualitySelections.appendChild(firstSelection);
                        }
                        
                        if (isAny || numGatherable === 0) {
                            qualitySelections.style.display = 'none';
                            return;
                        }
                        
                        qualitySelections.style.display = 'flex';
                        
                        // Add additional selections starting from index 1
                        for (let i = 1; i < numGatherable; i++) {
                            const selectionDiv = document.createElement('div');
                            selectionDiv.className = 'form-row';
                            selectionDiv.style.marginBottom = '0';
                            selectionDiv.style.display = 'flex';
                            selectionDiv.style.alignItems = 'center';
                            selectionDiv.style.gap = '0.5em';
                            
                            const label = document.createElement('label');
                            label.textContent = `Gathering node ${i + 1} quality:`;
                            label.style.color = '#e6eaf3';
                            label.style.minWidth = '180px';
                            
                            const select = document.createElement('select');
                            select.style.width = '8em';
                            select.style.background = '#36405a';
                            select.style.color = '#e6eaf3';
                            select.style.border = '1px solid #2c3242';
                            select.style.padding = '0.2em';
                            select.style.borderRadius = '4px';
                            
                            // Add "Any" option
                            const anyOption = document.createElement('option');
                            anyOption.value = 'any';
                            anyOption.textContent = 'Any';
                            select.appendChild(anyOption);
                            
                            // Add quality range options
                            qualityRanges.forEach(range => {
                                const option = document.createElement('option');
                                option.value = range.value;
                                option.value = range.value;
                                option.textContent = range.label;
                                select.appendChild(option);
                            });
                            
                            selectionDiv.appendChild(label);
                            selectionDiv.appendChild(select);
                            qualitySelections.appendChild(selectionDiv);
                        }
                    }
                    
                    function handleTypeChange(selectElement, inputElement) {
                        const isAny = selectElement.value === 'any';
                        inputElement.disabled = isAny;
                        inputElement.readOnly = isAny;
                        inputElement.style.background = isAny ? '#2c3242' : '#36405a';
                        inputElement.style.cursor = isAny ? 'not-allowed' : 'text';
                        inputElement.style.opacity = isAny ? '0.7' : '1';
                        inputElement.style.pointerEvents = isAny ? 'none' : 'auto';
                        
                        // Update quality selections when gatherable type changes
                        if (selectElement === nGatherableType) {
                            updateQualitySelections();
                        }
                    }
                    
                    // Add event listeners for type changes
                    ['n_nodes_type', 'n_gatherable_type', 'n_categories_type'].forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.addEventListener('change', function() {
                                handleTypeChange(this, document.getElementById(id.replace('_type', '')));
                            });
                            // Set initial state
                            handleTypeChange(select, document.getElementById(id.replace('_type', '')));
                        }
                    });
                    
                    // Prevent input when disabled
                    ['n_nodes', 'n_gatherable', 'n_categories'].forEach(id => {
                        const input = document.getElementById(id);
                        if (input) {
                            input.addEventListener('keydown', function(e) {
                                if (this.disabled) {
                                    e.preventDefault();
                                    return false;
                                }
                            });
                            input.addEventListener('input', function(e) {
                                if (this.disabled) {
                                    e.preventDefault();
                                    this.value = '';
                                    return false;
                                }
                            });
                        }
                    });
                    
                    // Add input event listener for n_gatherable to update quality selections
                    nGatherable.addEventListener('input', updateQualitySelections);
                    
                    // Set initial states
                    handleTypeChange(nNodesType, nNodes);
                    handleTypeChange(nGatherableType, nGatherable);
                    handleTypeChange(nCategoriesType, nCategories);
                    
                    // Ensure quality selections are initialized
                    updateQualitySelections();
                    
                    // Calculate probability
                    document.getElementById('calculateProbabilityBtn').addEventListener('click', function() {
                        const nNodes = document.getElementById('n_nodes_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_nodes').value);
                        const nNodesType = document.getElementById('n_nodes_type').value;
                        const nGatherable = document.getElementById('n_gatherable_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_gatherable').value);
                        const nGatherableType = document.getElementById('n_gatherable_type').value;
                        const nCategories = document.getElementById('n_categories_type').value === 'any' ? 'Any' : parseInt(document.getElementById('n_categories').value);
                        const nCategoriesType = document.getElementById('n_categories_type').value;
                        
                        // Collect quality ranges from all quality selection dropdowns
                        const qualityRanges = [];
                        document.querySelectorAll('#quality-selections select').forEach(select => {
                            if (select.value === 'any') {
                                qualityRanges.push('Any');
                            } else {
                                const [start, end] = select.value.split('-').map(Number);
                                qualityRanges.push([start, end]);
                            }
                        });
                        
                        // Calculate probability
                        const inhabitedSystemValue = document.getElementById('inhabited_system').value;
                        const inhabitedSystem = inhabitedSystemValue === 'any' ? null : inhabitedSystemValue === 'inhabited';
                        
                        const probability = probability_of_observation_with_per_gatherable_qualities(
                        nNodes,
                        nNodesType,
                        nGatherable,
                        nGatherableType,
                        nCategories,
                        nCategoriesType,
                        qualityRanges,
                        inhabitedSystem
                        );
                        
                        // Format probability with more decimal places for small values
                        const formatProbability = (prob) => {
                            if (prob < 0.001) {
                                return `${(prob * 100).toFixed(6)}%`;
                            }
                            return `${(prob * 100).toFixed(2)}%`;
                        };
                        
                        // Calculate and format estimated number of systems
                        const estimatedSystems = probability * 4000000;
                        const formatEstimatedSystems = (num) => {
                            if (num < 0.1) {
                                return num.toFixed(6);
                            }
                            return num.toFixed(2);
                        };
                        
                        // Display results
                        document.getElementById('probability_value').textContent = formatProbability(probability);
                        document.getElementById('estimated_systems').textContent = formatEstimatedSystems(estimatedSystems);
                    });
                });
            </script>
        </body>
        </html> 
        
